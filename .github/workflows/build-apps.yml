name: Build Native Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # â”€â”€â”€ Android Build (SIGNED AAB FOR PLAY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install dependencies
        run: npm ci

      - name: Build Web App
        run: npm run build || echo "No build script found"

      - name: Add Android platform
        run: npx cap add android

      - name: Create assets directory
        run: mkdir -p android/app/src/main/assets

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Copy custom app icons
        run: cp -r resources/android/res/. android/app/src/main/res/

      # ðŸ“± Update targetSdk, versionCode and versionName from git tag
      - name: Update build config
        run: |
          # Extract version from tag (v1.0.0-beta.9 -> 1.0.0-beta.9)
          TAG="${GITHUB_REF#refs/tags/v}"
          VERSION_NAME="${TAG:-1.0.0}"
          VERSION_CODE=$(git rev-list --count HEAD)

          echo "Tag: $TAG | versionName: $VERSION_NAME | versionCode: $VERSION_CODE"

          # Find the correct build.gradle file
          GRADLE_FILE=$(find android/app -name "build.gradle*" -maxdepth 1 | head -1)
          echo "=== Gradle file: $GRADLE_FILE ==="
          echo "=== BEFORE ==="
          grep -n -E "targetSdk|versionCode|versionName" "$GRADLE_FILE"

          # Handle both Groovy (versionCode 1) and Kotlin DSL (versionCode = 1)
          sed -i "s/targetSdk.*/targetSdk = 35/" "$GRADLE_FILE"
          sed -i "s/versionCode.*/versionCode = $VERSION_CODE/" "$GRADLE_FILE"
          sed -i "s/versionName.*/versionName = \"$VERSION_NAME\"/" "$GRADLE_FILE"

          echo "=== AFTER ==="
          grep -n -E "targetSdk|versionCode|versionName" "$GRADLE_FILE"

      # ðŸ— Build unsigned AAB
      - name: Build Android AAB
        working-directory: android
        run: ./gradlew bundleRelease

      # ðŸ” Sign AAB with jarsigner
      - name: Sign AAB
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE" | base64 -d > release-key.jks
          AAB_FILE=$(find android/app/build/outputs/bundle/release -name "*.aab" | head -1)
          echo "Signing: $AAB_FILE"
          jarsigner -verbose \
            -keystore release-key.jks \
            -storepass "$ANDROID_KEYSTORE_PASSWORD" \
            -keypass "$ANDROID_KEY_PASSWORD" \
            "$AAB_FILE" \
            "$ANDROID_KEY_ALIAS"
          echo "=== Verifying signature ==="
          jarsigner -verify "$AAB_FILE"

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: android/app/build/outputs/bundle/release/*.aab

  # â”€â”€â”€ iOS Build (signed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Web App
        run: npm run build || echo "No build script found"

      - name: Add iOS platform
        run: npx cap add ios

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Copy custom app icons
        run: |
          APPICONSET="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          cp resources/ios/*.png "$APPICONSET/"
          cp resources/ios/Contents.json "$APPICONSET/"

      - name: Patch Info.plist
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          VERSION_NAME="${TAG:-1.0.0}"
          VERSION_CODE=$(git rev-list --count HEAD)
          echo "versionName: $VERSION_NAME | versionCode (build): $VERSION_CODE"

          plutil -replace CFBundleDisplayName -string "FinDex" ios/App/App/Info.plist
          plutil -replace ITSAppUsesNonExemptEncryption -bool NO ios/App/App/Info.plist
          plutil -replace CFBundleShortVersionString -string "$VERSION_NAME" ios/App/App/Info.plist
          plutil -replace CFBundleVersion -string "$VERSION_CODE" ios/App/App/Info.plist

      - name: Install CocoaPods
        working-directory: ios/App
        run: |
          # CocoaPods forbids multiple post_install blocks, so patch the existing one
          # by inserting code-signing-disable lines after assertDeploymentTarget.
          awk '/assertDeploymentTarget\(installer\)/{
            print
            print "  installer.pods_project.targets.each do |target|"
            print "    target.build_configurations.each do |config|"
            print "      config.build_settings[\"CODE_SIGNING_ALLOWED\"] = \"NO\""
            print "      config.build_settings[\"CODE_SIGNING_REQUIRED\"] = \"NO\""
            print "    end"
            print "  end"
            next
          }
          {print}' Podfile > Podfile.tmp && mv Podfile.tmp Podfile
          pod install

      # ðŸ” Import certificate & provisioning profile
      - name: Setup signing
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          # Create temp keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "temp" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "temp" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Import certificate
          echo "$IOS_P12_BASE64" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 -P "$IOS_P12_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "temp" $KEYCHAIN_PATH

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode \
            > ~/Library/MobileDevice/Provisioning\ Profiles/findex.mobileprovision

          echo "=== Certificate imported ==="
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      # ðŸ— Build signed IPA
      - name: Build signed iOS IPA
        working-directory: ios/App
        run: |
          if [ -d "App.xcworkspace" ]; then
            BUILD_ARG="-workspace App.xcworkspace"
          else
            BUILD_ARG="-project App.xcodeproj"
          fi

          xcodebuild $BUILD_ARG \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -destination generic/platform=iOS \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            DEVELOPMENT_TEAM=BK3MDP3L75 \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="FinDex App Store" \
            archive

          # Export IPA
          cat > $RUNNER_TEMP/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>is.nickot.fishbox</key>
              <string>FinDex App Store</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: findex-ios
          path: ${{ runner.temp }}/export/*.ipa

      # ðŸš€ Upload to App Store Connect
      - name: Upload to App Store Connect
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
        run: |
          # Write the API key .p8 file (secret is stored base64-encoded)
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APPLE_API_KEY" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

          IPA_FILE=$(find $RUNNER_TEMP/export -name "*.ipa" | head -1)
          echo "Uploading: $IPA_FILE"

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_FILE" \
            --apiKey "$APPLE_API_KEY_ID" \
            --apiIssuer "$APPLE_API_ISSUER_ID"
